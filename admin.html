<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Admin ‚Äî Desafio 40+</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg:#0b1b2b;--panel:#12263a;--line:#18354f;--txt:#e8f1fb;--muted:#9bb5cf;--accent:#6aa5ff;--error:#ff6b6b;--ok:#33d69f}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    .wrap{max-width:1100px;margin:30px auto;padding:0 16px}
    h1{margin:0 0 12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.2);padding:20px}
    label{display:block;margin:12px 0 6px}
    input, select{width:100%;padding:12px;border-radius:10px;border:1px solid var(--line);background:#0f2032;color:var(--txt)}
    .btn{margin-top:12px;background:var(--accent);color:#061525;border:0;padding:12px 16px;border-radius:10px;font-weight:700}
    .btn.out{background:#2c3e50;color:#fff}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid var(--line);padding:8px;text-align:left}
    .err{color:var(--error);font-weight:700}
    .ok{color:var(--ok);font-weight:700}
    .hide{display:none}
    .foto{width:36px;height:36px;border-radius:50%;object-fit:cover;border:1px solid var(--line)}
    .row{display:flex;gap:8px;align-items:center}
  </style>
  <script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>
</head>
<body>
  <div class="wrap">
    <h1>Admin ‚Äî Desafio 40+</h1>
    <p class="muted">Fa√ßa login para gerenciar atletas, pontos, selos e publicar o c√≥digo do dia.</p>

    <!-- Login -->
    <div id="boxLogin" class="card">
      <h2>Login</h2>
      <label>E-mail</label><input id="email" type="email" placeholder="seu@email.com">
      <label>Senha</label><input id="senha" type="password" placeholder="********">
      <button id="btnLogin" class="btn">Entrar</button>
      <span id="loginMsg" class="err"></span>
    </div>

    <div id="boxAdmin" class="hide">
      <div class="row" style="justify-content:space-between;margin:8px 0 16px">
        <div class="muted" id="who"></div>
        <button id="btnLogout" class="btn out">Sair</button>
      </div>

      <div class="grid">
        <!-- C√ìDIGO DO DIA -->
        <div class="card">
          <h2>C√≥digo do dia</h2>
          <label>Data (YYYY-MM-DD)</label>
          <input id="cdData" placeholder="2025-08-21">
          <label>C√≥digo (sem acento; ex.: forca)</label>
          <input id="cdCodigo" placeholder="forca">
          <div class="row">
            <label style="margin:10px 0 0">Ativo?</label>
            <select id="cdAtivo">
              <option value="true">Sim</option>
              <option value="false">N√£o</option>
            </select>
          </div>
          <button id="btnSalvarCodigo" class="btn">Publicar / Salvar</button>
          <div id="cdMsg" class="muted"></div>
        </div>

        <!-- ADICIONAR/EDITAR ATLETA -->
        <div class="card">
          <h2>Adicionar / editar atleta</h2>
          <label>Nome</label><input id="aNome" placeholder="Ex.: L√∫cia Silva">
          <label>Foto (URL p√∫blica ‚Äî opcional)</label>
          <div class="row">
            <input id="aFoto" placeholder="https://...">
            <button id="btnUpload" class="btn" type="button">Enviar foto (Cloudinary)</button>
          </div>
          <label>Pontos iniciais</label><input id="aPontos" type="number" value="0">
          <label>Status</label><input id="aStatus" placeholder="Ex.: Em alta">
          <label>Selos (emojis separados por espa√ßo)</label><input id="aSelos" placeholder="ü•á üî• üíß">
          <button id="btnSalvarAtleta" class="btn">Salvar atleta</button>
          <div id="aMsg" class="muted"></div>
        </div>

        <!-- PONTUAR / STATUS / SELOS -->
        <div class="card">
          <h2>Pontuar / status / selos</h2>
          <label>Selecione a atleta</label>
          <select id="pSel"><option>Carregando‚Ä¶</option></select>

          <div class="row" style="gap:12px">
            <div style="flex:1">
              <label>Alterar pontos (+ ou ‚àí)</label><input id="pDelta" type="number" value="1">
              <button id="btnAplicarPontos" class="btn">Aplicar</button>
            </div>
            <div style="flex:1">
              <label>Novo status</label><input id="pStatus" placeholder="Ex.: Em alta">
              <button id="btnDefinirStatus" class="btn">Definir</button>
            </div>
          </div>

          <div class="row" style="gap:12px">
            <div style="flex:1">
              <label>Selo (emoji)</label><input id="pSelo" placeholder="üî•">
              <button id="btnAddSelo" class="btn">Adicionar</button>
            </div>
            <div style="flex:1">
              <label>Remover selo (emoji)</label><input id="pSeloRem" placeholder="üî•">
              <button id="btnRemSelo" class="btn">Remover</button>
            </div>
          </div>
          <div id="pMsg" class="muted"></div>
        </div>

        <!-- LISTA R√ÅPIDA -->
        <div class="card">
          <h2>Atletas (visualiza√ß√£o r√°pida)</h2>
          <table>
            <thead><tr><th>Foto</th><th>Nome</th><th>Pontos</th><th>Status</th><th>Selos</th></tr></thead>
            <tbody id="tbQuick"><tr><td colspan="5" class="muted">Carregando‚Ä¶</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase + L√≥gica Admin -->
  <script type="module">
    // ======== CONFIGURE AQUI O SEU PROJETO FIREBASE ========
    const firebaseConfig = {
      apiKey: "COLE_SUA_API_KEY_AQUI",
      authDomain: "SEU_PROJETO.firebaseapp.com",
      projectId: "SEU_PROJETO",
      storageBucket: "SEU_PROJETO.appspot.com",
      messagingSenderId: "XXXXXXXXXXXX",
      appId: "1:XXXXXXXXXXXX:web:XXXXXXXXXXXXXX"
    };
    // =======================================================

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, query, orderBy, getDocs, doc, setDoc, getDoc, updateDoc,
      onSnapshot, increment, arrayUnion, arrayRemove
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth = getAuth(app);

    // ---------- UI refs
    const boxLogin = document.getElementById('boxLogin');
    const boxAdmin = document.getElementById('boxAdmin');
    const loginMsg = document.getElementById('loginMsg');
    const who = document.getElementById('who');
    const email = document.getElementById('email');
    const senha = document.getElementById('senha');
    document.getElementById('btnLogin').onclick = async ()=>{
      loginMsg.textContent='';
      try{
        await signInWithEmailAndPassword(auth, email.value, senha.value);
      }catch(e){ loginMsg.textContent='Falha no login.'; }
    };
    document.getElementById('btnLogout').onclick = ()=>signOut(auth);

    onAuthStateChanged(auth, (u)=>{
      if(u){
        boxLogin.classList.add('hide'); boxAdmin.classList.remove('hide');
        who.textContent = `Logado como: ${u.email || u.uid}`;
        carregarTudo();
      }else{
        boxAdmin.classList.add('hide'); boxLogin.classList.remove('hide');
      }
    });

    // ---------- Utilidades
    const strip = s => (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();
    const idFromName = n => strip(n).replace(/[^a-z0-9\s-]/g,'').replace(/\s+/g,'-');
    const todayStr = () => {
      const d=new Date(); const yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    };

    // ---------- Cloudinary Upload (opcional)
    const fotoInput = document.getElementById('aFoto');
    document.getElementById('btnUpload').addEventListener('click', ()=>{
      const widget = cloudinary.createUploadWidget({
        cloudName: 'dj6gmz0pa',
        uploadPreset: 'checkin_unsigned',
        sources: ['local','url','camera'],
        multiple: false,
        maxFiles: 1
      }, (err, result)=>{
        if(!err && result && result.event === "success"){
          fotoInput.value = result.info.secure_url;
        }
      });
      widget.open();
    });

    // ---------- C√≥digo do dia
    const cdData = document.getElementById('cdData');
    const cdCodigo = document.getElementById('cdCodigo');
    const cdAtivo = document.getElementById('cdAtivo');
    const cdMsg = document.getElementById('cdMsg');
    cdData.value = todayStr();

    document.getElementById('btnSalvarCodigo').onclick = async ()=>{
      cdMsg.textContent='Salvando‚Ä¶';
      try{
        await setDoc(doc(db,'settings','dailyCode'), {
          date: cdData.value, code: strip(cdCodigo.value), active: (cdAtivo.value==='true')
        }, { merge:true });
        cdMsg.textContent='C√≥digo do dia salvo.';
      }catch(e){ cdMsg.textContent='Erro ao salvar c√≥digo.'; }
    };

    // ---------- Adicionar / editar atleta
    const aMsg   = document.getElementById('aMsg');
    document.getElementById('btnSalvarAtleta').onclick = async ()=>{
      aMsg.textContent='Salvando‚Ä¶';
      try{
        const nome  = document.getElementById('aNome').value;
        const foto  = document.getElementById('aFoto').value || null;
        const pontos= Number(document.getElementById('aPontos').value||0);
        const status= document.getElementById('aStatus').value || '';
        const selos = (document.getElementById('aSelos').value||'').trim();
        const id = idFromName(nome);
        await setDoc(doc(db,'athletes',id), {
          name: nome, photo: foto, points: pontos, status: status,
          badges: selos ? selos.split(/\s+/g) : []
        }, { merge:true });
        aMsg.textContent='Atleta salva.';
      }catch(e){ aMsg.textContent='Erro ao salvar atleta.'; }
    };

    // ---------- Pontuar / status / selos
    const pSel = document.getElementById('pSel');
    const pMsg = document.getElementById('pMsg');

    document.getElementById('btnAplicarPontos').onclick = async ()=>{
      pMsg.textContent='Aplicando‚Ä¶';
      try{
        const nome = pSel.value; if(!nome) throw 0;
        const id = idFromName(nome);
        const delta = Number(document.getElementById('pDelta').value||0);
        await updateDoc(doc(db,'athletes',id), { points: increment(delta) });
        pMsg.textContent='Pontos atualizados.';
      }catch(e){ pMsg.textContent='Erro ao aplicar pontos.'; }
    };
    document.getElementById('btnDefinirStatus').onclick = async ()=>{
      pMsg.textContent='Salvando‚Ä¶';
      try{
        const nome = pSel.value; if(!nome) throw 0;
        const id = idFromName(nome);
        const status = document.getElementById('pStatus').value||'';
        await updateDoc(doc(db,'athletes',id), { status });
        pMsg.textContent='Status atualizado.';
      }catch(e){ pMsg.textContent='Erro ao atualizar status.'; }
    };
    document.getElementById('btnAddSelo').onclick = async ()=>{
      pMsg.textContent='Salvando‚Ä¶';
      try{
        const nome = pSel.value; if(!nome) throw 0;
        const id = idFromName(nome);
        const selo = (document.getElementById('pSelo').value||'').trim();
        if(!selo){ pMsg.textContent='Informe um selo.'; return; }
        await updateDoc(doc(db,'athletes',id), { badges: arrayUnion(selo) });
        pMsg.textContent='Selo adicionado.';
      }catch(e){ pMsg.textContent='Erro ao adicionar selo.'; }
    };
    document.getElementById('btnRemSelo').onclick = async ()=>{
      pMsg.textContent='Removendo‚Ä¶';
      try{
        const nome = pSel.value; if(!nome) throw 0;
        const id = idFromName(nome);
        const selo = (document.getElementById('pSeloRem').value||'').trim();
        if(!selo){ pMsg.textContent='Informe o selo a remover.'; return; }
        await updateDoc(doc(db,'athletes',id), { badges: arrayRemove(selo) });
        pMsg.textContent='Selo removido.';
      }catch(e){ pMsg.textContent='Erro ao remover selo.'; }
    };

    // ---------- Listagens
    const tbQuick = document.getElementById('tbQuick');

    async function carregarTudo(){
      // select de atletas e tabela r√°pida
      const q = query(collection(db,'athletes'), orderBy('name'));
      onSnapshot(q, (snap)=>{
        // select
        pSel.innerHTML = `<option value="">Selecionar‚Ä¶</option>`;
        const rows = [];
        snap.forEach(docu=>{
          const a = docu.data();
          const o = document.createElement('option'); o.value=a.name; o.textContent=a.name; pSel.appendChild(o);
          rows.push(`
            <tr>
              <td>${a.photo?`<img class="foto" src="${a.photo}" alt="">`:'-'}</td>
              <td>${a.name||''}</td>
              <td>${a.points??0}</td>
              <td>${a.status||''}</td>
              <td>${Array.isArray(a.badges)?a.badges.join(' '):''}</td>
            </tr>
          `);
        });
        tbQuick.innerHTML = rows.length ? rows.join('') : `<tr><td colspan="5" class="muted">Sem atletas.</td></tr>`;
      }, ()=>{
        tbQuick.innerHTML = `<tr><td colspan="5" class="err">Erro ao carregar.</td></tr>`;
      });

      // carrega c√≥digo do dia atual (se existir)
      try{
        const c = await getDoc(doc(db,'settings','dailyCode'));
        if(c.exists()){
          const d = c.data();
          cdData.value = d.date || todayStr();
          cdCodigo.value = d.code || '';
          cdAtivo.value = String(!!d.active);
        }
      }catch(e){}
    }
  </script>
</body>
</html>
