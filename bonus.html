<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>B√¥nus extra ‚Äî Desafio 40+ Play</title>

  <!-- Bootstrap (fallback) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Seus estilos (mant√©m identidade visual) -->
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="styles.css">

  <!-- Fallback leve caso os CSS acima n√£o estejam dispon√≠veis -->
  <style>
    body { background:#0e1b2b; color:#e7eef7; }
    .card-dark { background:#12243a; border-radius:16px; box-shadow:0 8px 30px rgba(0,0,0,.3); }
    .text-dim { color:#9fb3c8; }
    .btn-primary { background:#2f6bff; border:none; }
    .btn-primary:hover { background:#2757cf; }
    .form-control { background:#0f2035; border-color:#1e385a; color:#e7eef7; }
    .form-control::file-selector-button{ background:#1b3b65; color:#e7eef7; border:none; padding:.4rem .7rem; border-radius:.375rem; }
    .progress-bar { background:#2f6bff; }
    a.link-soft{ color:#7cc7ff; text-decoration:none; } a.link-soft:hover{ text-decoration:underline; }
  </style>
</head>
<body>
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-12 col-lg-7">
        <div class="card-dark p-4 p-md-5">
          <h1 class="mb-2 text-center">B√¥nus de hoje (+10 pts)</h1>
          <p class="text-center text-dim mb-4">
            Envie <strong>uma foto ou v√≠deo</strong> da aula <strong>de hoje</strong> para ganhar +10 pontos.
          </p>

          <div class="alert alert-warning" role="alert" style="background:#2c3e55;color:#ffdd99;border:none">
            <ul class="mb-0">
              <li>O conte√∫do deve ser <strong>da aula de hoje</strong>.</li>
              <li>Envio de m√≠dia antiga pode resultar em <strong>perda de pontos</strong>.</li>
              <li>M√°ximo 1 b√¥nus por dia por atleta.</li>
            </ul>
          </div>

          <div id="hello" class="mb-3 text-dim"></div>
          <div id="status" class="mb-3"></div>

          <div class="mb-3">
            <label for="proof" class="form-label">Selecione a foto/v√≠deo da aula de hoje</label>
            <input id="proof" type="file" class="form-control" accept="image/*,video/*" />
            <div class="form-text text-dim">Formatos comuns de imagem/v√≠deo. Tamanho recomendado: at√© 25 MB.</div>
          </div>

          <div class="mb-4">
            <button id="btnSend" class="btn btn-primary w-100">Enviar e ganhar +10 pontos</button>
          </div>

          <div class="progress mb-3" style="height:10px; display:none" id="barWrap">
            <div id="bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
          </div>

          <div class="text-center">
            <a class="link-soft" href="index.html">‚Üê Voltar ao ranking</a>
          </div>

          <p id="session" class="text-center text-dim mt-2">Sess√£o ativa: ‚Ä¶</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <!-- Sua init -->
  <script src="firebase-init.js"></script>

  <script>
    // Utilidades
    const $ = sel => document.querySelector(sel);
    const params = new URLSearchParams(location.search);
    const athleteName = params.get('name') || '';

    const todayStr = (() => {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;           // ex: 2025-08-19
    })();

    const db = firebase.firestore();
    const storage = firebase.storage();

    // Login an√¥nimo (se necess√°rio)
    (async () => {
      if (!firebase.auth().currentUser) {
        await firebase.auth().signInAnonymously().catch(()=>{});
      }
      const u = firebase.auth().currentUser;
      if (u) $('#session').textContent = `Sess√£o ativa (UID: ${u.uid.slice(0,6)}...)`;
      if (athleteName) $('#hello').innerHTML = `Atleta: <strong>${athleteName}</strong> ‚Äî Dia: <strong>${todayStr}</strong>`;
    })();

    // Verifica se j√° ganhou hoje
    async function alreadyGotToday(uid, name, date) {
      const docId = `${(uid||'anon')}_${(name||'').toLowerCase()}_${date}`;
      const ref = db.collection('bonuses').doc(docId);
      const snap = await ref.get();
      return { exists: snap.exists, ref };
    }

    // Atualiza +10 pontos no /ranking (documento por nome)
    async function addTenPointsByName(name) {
      // 1) busca doc do ranking por nome
      const q = await db.collection('ranking').where('name','==', name).limit(1).get();
      if (q.empty) throw new Error('N√£o encontrei sua ficha no ranking.');
      const docRef = q.docs[0].ref;

      // 2) incrementa
      await docRef.update({ points: firebase.firestore.FieldValue.increment(10) });
    }

    // Upload + registro
    async function handleSend() {
      const status = $('#status');
      status.innerHTML = '';
      const file = $('#proof').files[0];

      if (!athleteName) {
        status.innerHTML = `<div class="alert alert-danger">Nome n√£o informado. Volte ao check-in e tente novamente.</div>`;
        return;
      }
      if (!file) {
        status.innerHTML = `<div class="alert alert-danger">Selecione uma foto ou v√≠deo da aula de hoje.</div>`;
        return;
      }
      if (file.size > 25 * 1024 * 1024) {
        status.innerHTML = `<div class="alert alert-danger">Arquivo muito grande (m√°x. 25MB).</div>`;
        return;
      }

      const user = firebase.auth().currentUser;
      const uid = user ? user.uid : 'anon';

      // Checa se j√° ganhou hoje
      const { exists, ref } = await alreadyGotToday(uid, athleteName, todayStr);
      if (exists) {
        status.innerHTML = `<div class="alert alert-warning">Voc√™ j√° garantiu os +10 pontos hoje. Obrigado!</div>`;
        return;
      }

      // Envia para Storage
      const safeName = athleteName.replace(/[^\w\s-]/g,'').trim().replace(/\s+/g,'_').toLowerCase();
      const path = `proofs/${todayStr}/${safeName}/${Date.now()}_${file.name}`;
      const task = storage.ref(path).put(file);

      // Barra de progresso
      $('#barWrap').style.display = 'block';
      task.on('state_changed', snap=>{
        const p = snap.bytesTransferred / snap.totalBytes * 100;
        $('#bar').style.width = `${p.toFixed(0)}%`;
      });

      try {
        await task;

        // (Opcional) URL para verifica√ß√£o posterior
        const url = await storage.ref(path).getDownloadURL();

        // Transa√ß√£o: registra b√¥nus do dia e incrementa pontos
        await db.runTransaction(async (tx) => {
          const snap = await tx.get(ref);
          if (snap.exists) return; // corrida dupla
          tx.set(ref, {
            uid, name: athleteName, date: todayStr,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            storagePath: path, downloadURL: url || null,
            awarded: 10
          });
        });

        await addTenPointsByName(athleteName);

        status.innerHTML = `<div class="alert alert-success"><strong>Parab√©ns!</strong> Upload conclu√≠do e voc√™ ganhou <strong>+10 pontos</strong> üéâ</div>`;
      } catch (e) {
        console.error(e);
        status.innerHTML = `<div class="alert alert-danger">Erro ao processar o b√¥nus: ${e.message}</div>`;
      }
    }

    $('#btnSend').addEventListener('click', handleSend);
  </script>
</body>
</html>
