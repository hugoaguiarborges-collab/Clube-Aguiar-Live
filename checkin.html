<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Check-in - Desafio 40+ Play</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;900&display=swap" rel="stylesheet">
  <style>
    /* ... seu CSS completo aqui ... */
    /* (mantive igual ao seu original) */
  </style>
</head>
<body>
  <div class="container">
    <h1>CHECK-IN DO TREINO</h1>
    <div class="subtitle">Confirme sua presen√ßa no treino e ganhe <b id="pontosCheckin">5 pontos</b> no ranking!</div>
    <form class="checkin-form" onsubmit="doCheckin();return false;">
      <div class="checkin-label">Selecione seu nome:</div>
      <select class="checkin-select" id="checkinSelect">
        <option value="" disabled selected>Selecione seu nome</option>
      </select>
      <div class="checkin-label">Digite o c√≥digo do treino:</div>
      <input class="checkin-input" id="checkinCode" placeholder="C√≥digo treino"/>
      <button class="checkin-btn" type="submit">Confirmar Check-in</button>
    </form>
    <div id="checkinResult"></div>
    <div id="extraPointsArea"></div>
    <button class="back-btn" onclick="window.location.href='index.html'">‚Üê Voltar ao Ranking</button>
  </div>
  <script>
    // ---- Firebase Configura√ß√£o correta ----
    const firebaseConfig = {
      apiKey: "AIzaSyAMf0Z5_a1DufNRCTHGPGC6ZBE9T2-tYAU",
      authDomain: "clube-aguiar-live.firebaseapp.com",
      projectId: "clube-aguiar-live",
      storageBucket: "clube-aguiar-live.appspot.com",
      messagingSenderId: "694025911850",
      appId: "1:694025911850:web:5f0c6117dbc60b15118d53"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    let todasAlunas = [];
    let checkinCodeOficial = ""; // din√¢mico!
    let pontosDoCheckin = 5;     // din√¢mico!
    let nomeSelecionado = "";
    let uploadFile = null;
    let autorizacao = false;

    function normalizarCodigo(str){
      return str
        .toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
        .replace(/√ß/g,'c')
        .replace(/[^a-z0-9]/g,'');
    }

    async function carregarCodigoTreino(){
      const doc = await db.collection("codes").doc("today").get();
      checkinCodeOficial = (doc.exists && doc.data().code) ? doc.data().code : "";
      pontosDoCheckin = (doc.exists && doc.data().points) ? doc.data().points : 5;
      document.getElementById("pontosCheckin").innerText = pontosDoCheckin + " pontos";
    }

    function preencherSelect(){
      const select = document.getElementById("checkinSelect");
      select.innerHTML = '<option value="" disabled selected>Selecione seu nome</option>';
      todasAlunas.forEach(a=>{
        select.innerHTML += `<option value="${a.nome}">${a.nome}</option>`;
      });
    }

    async function doCheckin(){
      const nome = document.getElementById("checkinSelect").value;
      const code = document.getElementById("checkinCode").value;
      nomeSelecionado = nome;
      if(!nome){
        alert("Selecione seu nome.");
        return;
      }
      if(!code){
        alert("Digite o c√≥digo do treino.");
        return;
      }
      if(normalizarCodigo(code) !== normalizarCodigo(checkinCodeOficial)){
        alert("C√≥digo do treino inv√°lido!");
        return;
      }
      // Atualiza Firestore com pontos do dia!
      const snap = await db.collection("usuarios").where("nome","==",nome).get();
      if(snap.empty){
        alert("Nome n√£o encontrado.");
        return;
      }
      const docUser = snap.docs[0];
      const pontosAtuais = docUser.data().pontos ?? 0;
      await db.collection("usuarios").doc(docUser.id).update({pontos: pontosAtuais + pontosDoCheckin});
      showCheckinSuccess(nome);
      showExtraPointsArea();
    }

    function showCheckinSuccess(nome){
      const motivacoes = [
        "Parab√©ns! Voc√™ est√° evoluindo a cada treino!",
        "Treino confirmado! Voc√™ est√° inspirando outras mulheres!",
        "Mandou bem demais, continue nessa energia!",
        "Mais pontos pra conta! Voc√™ √© exemplo de dedica√ß√£o!",
        "Sua for√ßa est√° transformando resultados! Continue!"
      ];
      const msg = motivacoes[Math.floor(Math.random()*motivacoes.length)];
      document.getElementById("checkinResult").innerHTML = `
        <div class="checkin-success">
          üéâ Parab√©ns, ${nome}! Voc√™ ganhou ${pontosDoCheckin} pontos.
          <div class="checkin-motivation">${msg}</div>
        </div>
      `;
      confetti();
      setTimeout(()=>document.getElementById("checkinResult").innerHTML="", 4000);
    }

    function showExtraPointsArea(){
      document.getElementById("extraPointsArea").innerHTML = `
        <div class="extra-points-area">
          <div class="extra-title">Que tal ganhar mais 10 pontos e disparar rumo √† lideran√ßa?</div>
          <div class="extra-subtitle">Envie uma foto ou v√≠deo seu fazendo o treino de <b>hoje</b>!<br>Essa √© sua chance de mostrar sua evolu√ß√£o e motivar outras alunas.</div>
          <button class="upload-btn" onclick="document.getElementById('fileInput').click()">Enviar foto ou v√≠deo do treino de hoje</button>
          <input type="file" id="fileInput" class="file-input" accept="image/*,video/*" onchange="handleFileChange(event)"/>
          <div id="uploadFileName" style="margin-top: 9px; color:#ffd700; font-size:0.97rem;"></div>
          <div class="checkbox-area">
            <input type="checkbox" id="autorizacaoCheckbox" onchange="handleAutorizacaoChange(event)">
            <label for="autorizacaoCheckbox">Autorizo que essa foto ou v√≠deo seja publicada na rede social do Clube Aguiar.</label>
          </div>
          <button class="confirm-upload-btn" id="confirmUploadBtn" onclick="confirmUpload()" disabled>Confirmar treino (+10 pontos)</button>
          <div id="uploadStatus" style="margin-top:8px;font-size:0.98rem"></div>
        </div>
      `;
      uploadFile = null;
      autorizacao = false;
      updateUploadButtonState();
    }

    function handleFileChange(event){
      uploadFile = event.target.files[0];
      document.getElementById("uploadFileName").innerText = uploadFile ? "Arquivo selecionado: " + uploadFile.name : "";
      updateUploadButtonState();
    }
    function handleAutorizacaoChange(event){
      autorizacao = event.target.checked;
      updateUploadButtonState();
    }
    function updateUploadButtonState(){
      const btn = document.getElementById("confirmUploadBtn");
      btn.disabled = !(uploadFile && autorizacao);
    }

    async function confirmUpload(){
      if(!(uploadFile && autorizacao)) return;
      document.getElementById("confirmUploadBtn").disabled = true;
      document.getElementById("uploadStatus").innerHTML = "Enviando arquivo...";
      try {
        // Nome: treino_hoje_nomealuna_timestamp.ext
        const ext = uploadFile.name.split('.').pop();
        const safeName = nomeSelecionado.replace(/[^a-z0-9]/gi,'_').toLowerCase();
        const fileName = `treino_hoje_${safeName}_${Date.now()}.${ext}`;
        const storageRef = storage.ref().child("uploads/"+fileName);
        await storageRef.put(uploadFile);
        // Atualiza Firestore +10 pontos
        const snap = await db.collection("usuarios").where("nome","==",nomeSelecionado).get();
        if(!snap.empty){
          const docUser = snap.docs[0];
          const pontosAtuais = docUser.data().pontos ?? 0;
          await db.collection("usuarios").doc(docUser.id).update({pontos: pontosAtuais + 10});
        }
        document.getElementById("uploadStatus").innerHTML = "";
        showUploadSuccess(nomeSelecionado);
        document.getElementById("extraPointsArea").innerHTML = "";
      } catch(e){
        document.getElementById("uploadStatus").innerHTML = "Erro no envio, tente novamente!";
        document.getElementById("confirmUploadBtn").disabled = false;
      }
    }

    function showUploadSuccess(nome){
      const motivacoes = [
        "Voc√™ √© inspira√ß√£o! Parab√©ns pelo envio!",
        "Treino registrado, +10 pontos! Continue assim!",
        "Sua dedica√ß√£o vai longe! Mantenha o foco!",
        "Exemplo de supera√ß√£o, parab√©ns!",
        "Sua energia motiva outras mulheres!"
      ];
      const msg = motivacoes[Math.floor(Math.random()*motivacoes.length)];
      document.getElementById("checkinResult").innerHTML = `
        <div class="checkin-success">
          üéâ Parab√©ns, ${nome}! Voc√™ ganhou mais 10 pontos pelo envio do treino!
          <div class="checkin-motivation">${msg}</div>
        </div>
      `;
      confetti();
      setTimeout(()=>document.getElementById("checkinResult").innerHTML="", 4000);
    }

    // Confetti animation
    function confetti(){
      const colors=["#ffd700","#7209b7","#38b4ff","#ff4d6d","#b0b0b0"];
      const confettiDiv = document.createElement("div");
      confettiDiv.className = "confetti";
      for(let i=0;i<60;i++){
        const span = document.createElement("span");
        const size = Math.random()*11+8;
        span.style.position="absolute";
        span.style.width=size+"px";
        span.style.height=size+"px";
        span.style.background=colors[Math.floor(Math.random()*colors.length)];
        span.style.borderRadius="50%";
        span.style.left=Math.random()*100+"vw";
        span.style.top=Math.random()*80+"vh";
        span.style.opacity=Math.random()*0.6+0.4;
        span.style.transform=`rotate(${Math.random()*360}deg)`;
        confettiDiv.appendChild(span);
      }
      document.body.appendChild(confettiDiv);
      setTimeout(()=>confettiDiv.remove(), 2300);
    }

    // ---- Consulta sem orderBy ----
    async function carregarNomes(){
      const snap = await db.collection("usuarios").get();
      todasAlunas = [];
      snap.forEach(doc => {
        const d = doc.data();
        todasAlunas.push({
          nome: d.nome,
        });
      });
      preencherSelect();
    }

    async function inicializarCheckin(){
      await carregarCodigoTreino();
      await carregarNomes();
    }
    inicializarCheckin();
  </script>
</body>
</html>
