<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Check-in ‚Äî Desafio 40+</title>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <style>
    :root{
      --bg:#081a34; --card:#0f2547; --card2:#132c55; --text:#e7f1ff; --muted:#9bb7e0;
      --accent:#2f5bff; --input:#0d2142;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; background:var(--bg); color:var(--text)}
    .wrap{max-width:680px; margin:48px auto; padding:0 20px}
    .card{background:linear-gradient(180deg,var(--card),var(--card2)); border-radius:18px; padding:24px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
    h1{margin:0 0 10px; font-weight:800}
    .sub{color:var(--muted); margin:0 0 18px}
    label{display:block; margin:14px 0 8px; font-weight:700}
    select,input,button{width:100%; padding:12px 14px; border-radius:12px; border:0; font-size:16px}
    select,input{background:var(--input); color:var(--text)}
    button{background:var(--accent); color:#fff; font-weight:800; cursor:pointer; margin-top:14px; box-shadow:0 6px 16px rgba(47,91,255,.35)}
    .msg{margin-top:12px; font-weight:800}
    a{color:#9ec3ff}
    .row{display:grid; grid-template-columns:1fr; gap:12px}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Fez seu treino?</h1>
      <p class="sub">N√£o d√™ vacilo! Escolha seu nome, digite o C√≥digo-treino informado na aula de hoje e garanta seus pontos!</p>

      <div class="row">
        <div>
          <label for="nomes">Seu nome</label>
          <select id="nomes"><option>Carregando‚Ä¶</option></select>
        </div>

        <div>
          <label for="codigo">C√≥digo do treino</label>
          <input id="codigo" type="text" placeholder="Ex.: FOCO" autocomplete="one-time-code" />
        </div>
      </div>

      <button id="btnCheckin" disabled>Confirmar treino</button>
      <div id="msg" class="msg"></div>

      <p style="margin-top:18px;"><a href="./index.html">‚Üê Voltar ao ranking</a></p>
      <p id="authInfo" class="muted"></p>
    </div>
  </div>

  <script>
    // 1) Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAMf0Z5_a1DufNRCTHGPGC6ZBE9T2-tYAU",
      authDomain: "clube-aguiar-live.firebaseapp.com",
      projectId: "clube-aguiar-live",
      storageBucket: "clube-aguiar-live.appspot.com",
      messagingSenderId: "694025911850",
      appId: "1:694025911850:web:5f0c6117dbc60b15118d53"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Espera login an√¥nimo para habilitar o bot√£o (regras exigem request.auth != null para somar pontos)
    const btn = document.querySelector('#btnCheckin');
    const authInfo = document.querySelector('#authInfo');
    firebase.auth().signInAnonymously().catch(()=>{});
    firebase.auth().onAuthStateChanged(u=>{
      if(u){
        btn.disabled = false;
        authInfo.textContent = `Sess√£o ativa (UID an√¥nimo: ${u.uid.substring(0,6)}‚Ä¶)`;
      }else{
        btn.disabled = true;
        authInfo.textContent = `Iniciando sess√£o an√¥nima‚Ä¶`;
      }
    });

    // helpers
    const $ = (sel)=>document.querySelector(sel);
    const nomesSelect = $('#nomes'), inputCodigo = $('#codigo'), msg = $('#msg');

    function normalizeId(s){
      return String(s||"").trim().toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");
    }
    const normalizeText=(s)=>String(s||'').trim().toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'');

    async function carregarNomes(){
      try{
        const snap = await db.collection('players').orderBy('name').get();
        const nomes = [];
        snap.forEach(d=>{ const x=d.data(); if(x && x.name) nomes.push(x.name); });
        if (!nomes.length) { nomesSelect.innerHTML = `<option>Nenhuma atleta cadastrada</option>`; return; }
        nomesSelect.innerHTML = nomes.map(n=>`<option value="${n}">${n}</option>`).join('');
        localStorage.setItem('nomesPlayers', JSON.stringify(nomes));
      }catch(e){
        const cache = localStorage.getItem('nomesPlayers');
        if (cache) {
          const nomes = JSON.parse(cache);
          nomesSelect.innerHTML = nomes.map(n=>`<option value="${n}">${n}</option>`).join('');
        } else {
          nomesSelect.innerHTML = `<option>Erro ao carregar nomes</option>`;
        }
      }
    }

    async function registrarCheckin(){
      msg.textContent = ''; msg.style.color = '';

      // Garante auth (regras da soma de pontos exigem auth != null)
      const u = firebase.auth().currentUser;
      if (!u) { msg.textContent = 'Espere um instante‚Ä¶ ativando sess√£o.'; msg.style.color='salmon'; return; }

      const name = nomesSelect?.value, codeUser = inputCodigo?.value;
      if(!name || !codeUser){ msg.textContent='Selecione o nome e informe o c√≥digo.'; msg.style.color='salmon'; return; }

      // L√™ configura√ß√£o do dia
      let cfg;
      try{
        const snap = await db.collection('meta').doc('checkin').get();
        if(!snap.exists){ msg.textContent='Configura√ß√£o de check-in n√£o encontrada.'; msg.style.color='salmon'; return; }
        cfg = snap.data(); // { code, points }
      }catch(e){ msg.textContent='Erro ao ler configura√ß√£o.'; msg.style.color='salmon'; return; }

      const codeOfDay = cfg?.code, points = Number(cfg?.points)||1;
      if (normalizeText(codeUser) !== normalizeText(codeOfDay)){
        msg.textContent = 'C√≥digo inv√°lido.'; msg.style.color = 'salmon'; return;
      }

      // 1) cria /checkins
      try{
        await db.collection('checkins').add({
          name,
          userId: u.uid,
          code: normalizeText(codeUser),
          points,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }catch(e){
        console.error('CHECKIN_CREATE', e);
        msg.textContent = `Erro ao registrar (CHECKIN_CREATE): ${e.code || e.message}`;
        msg.style.color = 'salmon';
        return;
      }

      // 2) soma pontos em players/{id}
      const playerId = normalizeId(name);
      try{
        await db.runTransaction(async (t)=>{
          const ref = db.collection('players').doc(playerId);
          const snap = await t.get(ref);
          const cur = Number((snap.data()||{}).points||0);
          t.set(ref, { points: cur + points }, { merge:true }); // set(merge) => update
        });

        msg.textContent = `üéâ Parab√©ns! Voc√™ somou ${points} ponto(s).`;
        msg.style.color = 'limegreen';
        inputCodigo.value = '';
        msg.scrollIntoView({behavior:'smooth', block:'center'});
      }catch(e){
        console.error('POINTS_UPDATE', e);
        msg.textContent = `Check-in lan√ßado, mas houve erro ao somar (POINTS_UPDATE): ${e.code || e.message}`;
        msg.style.color = 'salmon';
      }
    }

    document.querySelector('#btnCheckin').addEventListener('click', registrarCheckin);
    carregarNomes();
  </script>
</body>
</html>
