<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Check-in ‚Äî Desafio 40+</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg:#0b1b2b;--panel:#12263a;--line:#18354f;--txt:#e8f1fb;--muted:#9bb5cf;--accent:#6aa5ff;--error:#ff6b6b;--ok:#33d69f}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    .wrap{max-width:720px;margin:40px auto;padding:0 16px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.2);padding:24px}
    h1{font-size:32px;margin:0 0 10px;text-align:center}
    p.muted{color:var(--muted);text-align:center;margin-top:0}
    label{display:block;margin:18px 0 6px}
    input, select{width:100%;padding:14px;border-radius:12px;border:1px solid var(--line);background:#0f2032;color:var(--txt);font-size:16px}
    .btn{margin-top:16px;width:100%;background:var(--accent);color:#061525;border:0;padding:14px;border-radius:12px;font-weight:700;font-size:16px}
    .msg{margin-top:16px;padding:12px;border-radius:10px;display:none}
    .msg.ok{display:block;background:#0f2b1e;border:1px solid #1b7c59;color:#b8f3da}
    .msg.err{display:block;background:#2b0f12;border:1px solid #923639;color:var(--error)}
    .link{display:inline-block;margin-top:14px;color:var(--accent);text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Fez seu treino?</h1>
      <p class="muted">Escolha seu nome, digite o C√≥digo-treino de hoje e garanta seus pontos!</p>

      <label>Seu nome</label>
      <select id="selNome">
        <option value="" selected disabled>Carregando nomes‚Ä¶</option>
      </select>

      <label>C√≥digo do treino</label>
      <input id="inpCodigo" placeholder="Ex.: forca" />

      <button id="btn" class="btn">Confirmar treino</button>

      <div id="msg" class="msg"></div>

      <a class="link" href="index.html">‚Üê Voltar ao ranking</a>
      <p class="muted" id="sessao"></p>
    </div>
  </div>

  <!-- Firebase + Check-in -->
  <script type="module">
    // ======== CONFIGURE AQUI O SEU PROJETO FIREBASE ========
    const firebaseConfig = {
      apiKey: "COLE_SUA_API_KEY_AQUI",
      authDomain: "SEU_PROJETO.firebaseapp.com",
      projectId: "SEU_PROJETO",
      storageBucket: "SEU_PROJETO.appspot.com",
      messagingSenderId: "XXXXXXXXXXXX",
      appId: "1:XXXXXXXXXXXX:web:XXXXXXXXXXXXXX"
    };
    // =======================================================

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, getDocs, query, orderBy, doc, getDoc, setDoc, updateDoc, increment, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getAuth, signInAnonymously, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth = getAuth(app);

    const selNome = document.getElementById('selNome');
    const inpCodigo = document.getElementById('inpCodigo');
    const btn = document.getElementById('btn');
    const msg = document.getElementById('msg');
    const sessao = document.getElementById('sessao');

    // Utilidades
    const todayStr = () => {
      const d=new Date();
      const yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    };
    const strip = s => (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();
    const idFromName = n => strip(n).replace(/[^a-z0-9\s-]/g,'').replace(/\s+/g,'-');

    // Sess√£o an√¥nima (mostra UID √∫til p/ debug)
    signInAnonymously(auth).catch(()=>{});
    onAuthStateChanged(auth, (u)=>{
      if(u) sessao.textContent = `Sess√£o ativa (UID: ${u.uid.slice(0,8)}‚Ä¶ )`;
    });

    // Carrega todas as atletas
    async function carregarNomes(){
      selNome.innerHTML = `<option value="" selected disabled>Selecionar‚Ä¶</option>`;
      const q = query(collection(db,'athletes'), orderBy('name'));
      const snap = await getDocs(q);
      let count=0;
      snap.forEach(docu=>{
        const a = docu.data();
        const o = document.createElement('option');
        o.value = a.name;
        o.textContent = a.name;
        selNome.appendChild(o);
        count++;
      });
      if(!count){
        const o = document.createElement('option');
        o.value = '';
        o.textContent = 'Nenhuma atleta cadastrada';
        selNome.appendChild(o);
      }
    }

    // Busca o c√≥digo do dia
    async function getDailyCode(){
      const ref = doc(db,'settings','dailyCode');
      const snap = await getDoc(ref);
      if(!snap.exists()) return null;
      const d = snap.data();
      if(!d.active) return null;
      if(String(d.date) !== todayStr()) return null;
      return String(d.code||'');
    }

    async function confirmar(){
      msg.className='msg'; msg.style.display='none';
      const nome = selNome.value;
      const codigoDigitado = strip(inpCodigo.value);
      if(!nome){msg.className='msg err'; msg.textContent='Selecione seu nome.'; msg.style.display='block'; return;}
      if(!codigoDigitado){msg.className='msg err'; msg.textContent='Digite o c√≥digo do treino.'; msg.style.display='block'; return;}

      const codeHoje = await getDailyCode();
      if(!codeHoje){msg.className='msg err'; msg.textContent='N√£o h√° c√≥digo publicado para hoje.'; msg.style.display='block'; return;}

      if(codigoDigitado !== strip(codeHoje)){
        msg.className='msg err'; msg.textContent='C√≥digo inv√°lido.'; msg.style.display='block'; return;
      }

      const id = idFromName(nome);
      const athleteRef = doc(db,'athletes', id);
      const aSnap = await getDoc(athleteRef);
      if(!aSnap.exists()){
        msg.className='msg err'; msg.textContent='Atleta n√£o encontrada.'; msg.style.display='block'; return;
      }

      // Evitar duplicado no mesmo dia
      const chkId = `${id}-${todayStr()}`;
      const chkRef = doc(db,'checkins', chkId);
      const cSnap = await getDoc(chkRef);
      if(cSnap.exists()){
        msg.className='msg err'; msg.textContent='Voc√™ j√° fez check-in hoje.'; msg.style.display='block'; return;
      }

      // Grava check-in e soma 1 ponto
      await setDoc(chkRef, {
        athleteId: id, name: nome, date: todayStr(), createdAt: serverTimestamp(), code: codeHoje
      });
      await updateDoc(athleteRef, { points: increment(1) });

      msg.className='msg ok'; msg.textContent='Check-in confirmado! +1 ponto üëè'; msg.style.display='block';
      inpCodigo.value='';
    }

    btn.addEventListener('click', confirmar);
    carregarNomes();
  </script>
</body>
</html>
