<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Check-in — Desafio 40+</title>

  <!-- Firebase v8 (simples no HTML) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <style>
    :root{
      --bg:#081a34;
      --card:#0f2547;
      --card2:#132c55;
      --text:#e7f1ff;
      --muted:#9bb7e0;
      --accent:#2f5bff;
      --input:#0d2142;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width:680px; margin:48px auto; padding:0 20px;
    }
    .card{
      background:linear-gradient(180deg, var(--card), var(--card2));
      border-radius:18px; padding:24px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    h1{margin:0 0 10px; font-weight:800}
    .sub{color:var(--muted); margin:0 0 18px}
    label{display:block; margin:14px 0 8px; font-weight:700}
    select,input,button{
      width:100%; padding:12px 14px; border-radius:12px; border:0; font-size:16px;
    }
    select,input{ background:var(--input); color:var(--text); }
    button{
      background:var(--accent); color:#fff; font-weight:800; cursor:pointer; margin-top:14px;
      box-shadow:0 6px 16px rgba(47,91,255,.35);
    }
    .msg{margin-top:12px; font-weight:800}
    a{color:#9ec3ff}
    .row{display:grid; grid-template-columns:1fr; gap:12px}
    .foot{margin-top:14px; color:var(--muted); font-size:14px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Fazer check-in</h1>
      <p class="sub">Selecione seu nome e digite o código da aula de hoje.</p>

      <div class="row">
        <div>
          <label for="nomes">Seu nome</label>
          <select id="nomes"><option>Carregando…</option></select>
        </div>

        <div>
          <label for="codigo">Código do treino</label>
          <input id="codigo" type="text" placeholder="Ex.: FOCO" autocomplete="one-time-code" />
        </div>
      </div>

      <button id="btnCheckin">Fazer check-in</button>
      <div id="msg" class="msg"></div>

      <p class="foot" style="margin-top:18px;"><a href="./index.html">← Voltar ao ranking</a></p>
    </div>
  </div>

  <script>
    // 1) Inicializa Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAMf0Z5_a1DufNRCTHGPGC6ZBE9T2-tYAU",
      authDomain: "clube-aguiar-live.firebaseapp.com",
      projectId: "clube-aguiar-live",
      storageBucket: "clube-aguiar-live.appspot.com",
      messagingSenderId: "694025911850",
      appId: "1:694025911850:web:5f0c6117dbc60b15118d53"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

    // 2) Auth anônima (silenciosa)
    firebase.auth().signInAnonymously().catch(function(){});

    const db = firebase.firestore();

    // helpers
    const $ = (sel)=>document.querySelector(sel);
    const nomesSelect = $('#nomes');
    const inputCodigo = $('#codigo');
    const btn = $('#btnCheckin');
    const msg = $('#msg');

    // Normaliza código (remove acentos/maiúsculas/espaços extras)
    function normalize(s){
      return String(s||'').trim().toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g,''); // remove acentos
    }

    async function carregarNomes(){
      try{
        const snap = await db.collection('players').orderBy('name').get();
        const nomes = [];
        snap.forEach(d=>{
          const x = d.data();
          if (x && x.name) nomes.push(x.name);
        });

        if (!nomes.length) {
          nomesSelect.innerHTML = `<option>Nenhuma atleta cadastrada</option>`;
          return;
        }

        nomesSelect.innerHTML = nomes.map(n=>`<option value="${n}">${n}</option>`).join('');
        // cache local (fallback caso o Firestore falhe)
        localStorage.setItem('nomesPlayers', JSON.stringify(nomes));
      }catch(e){
        console.error('Falha ao carregar nomes', e);
        const cache = localStorage.getItem('nomesPlayers');
        if (cache) {
          const nomes = JSON.parse(cache);
          nomesSelect.innerHTML = nomes.map(n=>`<option value="${n}">${n}</option>`).join('');
        } else {
          nomesSelect.innerHTML = `<option>Erro ao carregar nomes</option>`;
        }
      }
    }

    async function registrarCheckin(){
      msg.textContent = '';
      msg.style.color = '';

      const name = nomesSelect?.value;
      const codeUser = inputCodigo?.value;

      if (!name || !codeUser) {
        msg.textContent = 'Selecione o nome e informe o código.';
        msg.style.color = 'salmon';
        return;
      }

      // 1) Lê código do dia em meta/checkin
      let cfg;
      try{
        const snap = await db.collection('meta').doc('checkin').get();
        if (!snap.exists) {
          msg.textContent = 'Configuração de check-in não encontrada.';
          msg.style.color = 'salmon';
          return;
        }
        cfg = snap.data(); // { code, points }
      }catch(e){
        console.error(e);
        msg.textContent = 'Erro ao ler configuração do check-in.';
        msg.style.color = 'salmon';
        return;
      }

      const codeOfDay = cfg?.code;
      const points = Number(cfg?.points) || 1;

      if (normalize(codeUser) !== normalize(codeOfDay)) {
        msg.textContent = 'Código inválido.';
        msg.style.color = 'salmon';
        return;
      }

      // 2) Grava o check-in (APENAS os campos permitidos pelas regras)
      try{
        await db.collection('checkins').add({
          name: name,
          userId: null,
          code: normalize(codeUser),
          points: points,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        msg.textContent = '✅ Check-in registrado!';
        msg.style.color = 'limegreen';
        inputCodigo.value = '';

        // (opcional) rolar pra mensagem
        msg.scrollIntoView({behavior:'smooth', block:'center'});
      }catch(e){
        console.error(e);
        msg.textContent = 'Erro ao registrar. Tente novamente.';
        msg.style.color = 'salmon';
      }
    }

    btn.addEventListener('click', registrarCheckin);
    carregarNomes();
  </script>
</body>
</html>
