<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Check-in - Desafio 40+ Play</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;900&display=swap" rel="stylesheet">
  <style>
    body {
      min-height: 100vh;
      background: radial-gradient(ellipse at top,#163869 0%,#061b30 100%);
      color: #f8f8f8;
      font-family: Poppins, Arial, sans-serif;
      margin: 0;
    }
    .container {
      max-width: 440px;
      margin: 0 auto;
      margin-top: 70px;
      background: rgba(255,255,255,0.11);
      border-radius: 28px;
      box-shadow: 0 6px 32px -10px #0008;
      padding: 38px 28px 28px 28px;
      text-align: center;
    }
    h1 {
      color: #fffde5;
      font-size: 2.1rem;
      font-weight: 900;
      margin-bottom: 16px;
      text-shadow: 0 2px 18px #000b;
      letter-spacing: 1px;
      line-height: 1.13;
    }
    .subtitle {
      color: #e3e3e3;
      font-size: 1.13rem;
      font-weight: 600;
      margin-bottom: 24px;
      line-height: 1.32;
      text-shadow:0 2px 18px #0006;
    }
    .checkin-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
      align-items: center;
      margin-bottom: 22px;
    }
    .checkin-select {
      border-radius: 12px;
      padding: 11px 18px;
      font-size: 1.09rem;
      font-family: Poppins, Arial, sans-serif;
      background: #143869;
      color: #fffde5;
      border: none;
      font-weight: 700;
      box-shadow: 0 2px 8px #0003;
      margin-bottom: 0;
      min-width: 220px;
    }
    .checkin-input {
      border-radius: 12px;
      padding: 11px 18px;
      font-size: 1.09rem;
      font-family: Poppins, Arial, sans-serif;
      background: #143869;
      color: #fffde5;
      border: none;
      font-weight: 700;
      box-shadow: 0 2px 8px #0003;
      min-width: 220px;
    }
    .checkin-btn {
      background: linear-gradient(180deg,#ffd700,#e3c300);
      color: #143869;
      font-weight: 900;
      font-size: 1.13rem;
      border: none;
      border-radius: 13px;
      padding: 13px 0;
      width: 220px;
      cursor: pointer;
      letter-spacing: 1px;
      box-shadow: 0 2px 12px #0002;
      transition: background .2s;
    }
    .checkin-btn:hover { background: linear-gradient(180deg,#e3c300,#ffd700);}
    .checkin-label {
      color: #fffde5;
      font-weight: 700;
      font-size: 1.09rem;
      margin-bottom: 6px;
      text-align: left;
      width: 100%;
    }
    .confetti {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      pointer-events: none;
      z-index: 9999;
      animation: fadeout 2.5s forwards;
    }
    @keyframes fadeout { 100% { opacity: 0; } }
    .checkin-success {
      margin-top: 24px;
      background: linear-gradient(90deg, #ffd700 0%, #ffe066 100%);
      color: #143869;
      font-weight: 900;
      font-size: 1.33rem;
      border-radius: 20px;
      padding: 24px 14px;
      box-shadow: 0 2px 18px #0003;
      text-align: center;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
      letter-spacing: 1px;
    }
    .checkin-motivation {
      margin-top: 12px;
      font-size: 1.18rem;
      color: #183a73;
      font-weight: 700;
      margin-bottom: 0;
    }
    .extra-points-area {
      margin-top: 30px;
      background: rgba(255,255,255,0.15);
      border-radius: 18px;
      padding: 20px 10px 16px 10px;
      box-shadow: 0 2px 16px #0002;
      max-width: 420px;
      margin-left: auto;
      margin-right: auto;
      text-align: center;
    }
    .extra-title {
      font-size: 1.13rem;
      font-weight: 900;
      color: #ffef5b;
      margin-bottom: 7px;
      text-shadow:0 2px 18px #0006;
    }
    .extra-subtitle {
      font-size: 1.03rem;
      color: #e3e3e3;
      font-weight: 500;
      margin-bottom: 16px;
      line-height: 1.32;
    }
    .upload-btn {
      background: linear-gradient(180deg,#38b4ff,#2f5aa2);
      color: #fffde5;
      font-weight: 900;
      font-size: 1.09rem;
      border: none;
      border-radius: 13px;
      padding: 12px 0;
      width: 210px;
      cursor: pointer;
      letter-spacing: 1px;
      margin-bottom: 10px;
      box-shadow: 0 2px 12px #0002;
      transition: background .2s;
    }
    .upload-btn:hover {background: linear-gradient(180deg,#2f5aa2,#38b4ff);}
    .file-input {
      display: none;
    }
    .checkbox-area {
      margin-top: 10px;
      margin-bottom: 10px;
      font-size: 0.97rem;
      color: #fffde5;
      font-weight: 500;
      text-align: left;
      max-width: 350px;
      margin-left: auto;
      margin-right: auto;
      display: flex;
      align-items: center;
      gap:8px;
    }
    .checkbox-area input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #2f5aa2;
      margin-right: 8px;
    }
    .confirm-upload-btn {
      background: linear-gradient(180deg,#ffd700,#e3c300);
      color: #143869;
      font-weight: 900;
      font-size: 1.09rem;
      border: none;
      border-radius: 13px;
      padding: 12px 0;
      width: 210px;
      cursor: pointer;
      letter-spacing: 1px;
      margin-bottom: 10px;
      box-shadow: 0 2px 12px #0002;
      transition: background .2s;
    }
    .confirm-upload-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: #ccc;
    }
    @media (max-width: 540px) {
      .container {padding: 20px 4vw;}
      h1 {font-size:1.23rem;}
      .checkin-select,.checkin-input,.checkin-btn {min-width:unset;width:100%;}
      .back-btn {padding: 13px 0; width:98%;}
      .extra-points-area {padding: 10px 2vw;}
    }
    .back-btn {
      margin-top: 32px;
      background: linear-gradient(180deg,#3974cb,#183a73);
      color: #fff;
      font-weight: 700;
      font-size: 1.09rem;
      border: none;
      border-radius: 13px;
      padding: 13px 48px;
      cursor: pointer;
      letter-spacing: 1px;
      box-shadow: 0 2px 12px #0002;
      transition: background .2s;
      text-align: center;
    }
    .back-btn:hover {background: linear-gradient(180deg,#183a73,#3974cb);}
  </style>
</head>
<body>
  <div class="container">
    <h1>CHECK-IN DO TREINO</h1>
    <div class="subtitle">Confirme sua presença no treino e ganhe <b id="pontosCheckin">5 pontos</b> no ranking!</div>
    <form class="checkin-form" onsubmit="doCheckin();return false;">
      <div class="checkin-label">Selecione seu nome:</div>
      <select class="checkin-select" id="checkinSelect">
        <option value="" disabled selected>Selecione seu nome</option>
      </select>
      <div class="checkin-label">Digite o código do treino:</div>
      <input class="checkin-input" id="checkinCode" placeholder="Código treino"/>
      <button class="checkin-btn" type="submit">Confirmar Check-in</button>
    </form>
    <div id="checkinResult"></div>
    <div id="extraPointsArea"></div>
    <button class="back-btn" onclick="window.location.href='index.html'">← Voltar ao Ranking</button>
  </div>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAMf0Z5_a1DufNRCTHGPGC6ZBE9T2-tYAU",
      authDomain: "clube-aguiar-live.firebaseapp.com",
      projectId: "clube-aguiar-live",
      storageBucket: "clube-aguiar-live.appspot.com",
      messagingSenderId: "694025911850",
      appId: "1:694025911850:web:5f0c6117dbc60b15118d53"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    let todasAlunas = [];
    let checkinCodeOficial = ""; // dinâmico!
    let pontosDoCheckin = 5;     // dinâmico!
    let nomeSelecionado = "";
    let uploadFile = null;
    let autorizacao = false;

    function normalizarCodigo(str){
      return str
        .toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
        .replace(/ç/g,'c')
        .replace(/[^a-z0-9]/g,'');
    }

    async function carregarCodigoTreino(){
      // Busca o código do treino do dia e os pontos do documento correto!
      const doc = await db.collection("codes").doc("today").get();
      checkinCodeOficial = (doc.exists && doc.data().code) ? doc.data().code : "";
      pontosDoCheckin = (doc.exists && doc.data().points) ? doc.data().points : 5;
      document.getElementById("pontosCheckin").innerText = pontosDoCheckin + " pontos";
    }

    function preencherSelect(){
      const select = document.getElementById("checkinSelect");
      select.innerHTML = '<option value="" disabled selected>Selecione seu nome</option>';
      todasAlunas.forEach(a=>{
        select.innerHTML += `<option value="${a.nome}">${a.nome}</option>`;
      });
    }

    async function doCheckin(){
      const nome = document.getElementById("checkinSelect").value;
      const code = document.getElementById("checkinCode").value;
      nomeSelecionado = nome;
      if(!nome){
        alert("Selecione seu nome.");
        return;
      }
      if(!code){
        alert("Digite o código do treino.");
        return;
      }
      if(normalizarCodigo(code) !== normalizarCodigo(checkinCodeOficial)){
        alert("Código do treino inválido!");
        return;
      }
      // Atualiza Firestore com pontos do dia!
      const snap = await db.collection("usuarios").where("nome","==",nome).get();
      if(snap.empty){
        alert("Nome não encontrado.");
        return;
      }
      const docUser = snap.docs[0];
      const pontosAtuais = docUser.data().pontos ?? 0;
      await db.collection("usuarios").doc(docUser.id).update({pontos: pontosAtuais + pontosDoCheckin});
      showCheckinSuccess(nome);
      showExtraPointsArea();
    }

    function showCheckinSuccess(nome){
      const motivacoes = [
        "Parabéns! Você está evoluindo a cada treino!",
        "Treino confirmado! Você está inspirando outras mulheres!",
        "Mandou bem demais, continue nessa energia!",
        "Mais pontos pra conta! Você é exemplo de dedicação!",
        "Sua força está transformando resultados! Continue!"
      ];
      const msg = motivacoes[Math.floor(Math.random()*motivacoes.length)];
      document.getElementById("checkinResult").innerHTML = `
        <div class="checkin-success">
          🎉 Parabéns, ${nome}! Você ganhou ${pontosDoCheckin} pontos.
          <div class="checkin-motivation">${msg}</div>
        </div>
      `;
      confetti();
      setTimeout(()=>document.getElementById("checkinResult").innerHTML="", 4000);
    }

    function showExtraPointsArea(){
      document.getElementById("extraPointsArea").innerHTML = `
        <div class="extra-points-area">
          <div class="extra-title">Que tal ganhar mais 10 pontos e disparar rumo à liderança?</div>
          <div class="extra-subtitle">Envie uma foto ou vídeo seu fazendo o treino de <b>hoje</b>!<br>Essa é sua chance de mostrar sua evolução e motivar outras alunas.</div>
          <button class="upload-btn" onclick="document.getElementById('fileInput').click()">Enviar foto ou vídeo do treino de hoje</button>
          <input type="file" id="fileInput" class="file-input" accept="image/*,video/*" onchange="handleFileChange(event)"/>
          <div id="uploadFileName" style="margin-top: 9px; color:#ffd700; font-size:0.97rem;"></div>
          <div class="checkbox-area">
            <input type="checkbox" id="autorizacaoCheckbox" onchange="handleAutorizacaoChange(event)">
            <label for="autorizacaoCheckbox">Autorizo que essa foto ou vídeo seja publicada na rede social do Clube Aguiar.</label>
          </div>
          <button class="confirm-upload-btn" id="confirmUploadBtn" onclick="confirmUpload()" disabled>Confirmar treino (+10 pontos)</button>
          <div id="uploadStatus" style="margin-top:8px;font-size:0.98rem"></div>
        </div>
      `;
      uploadFile = null;
      autorizacao = false;
      updateUploadButtonState();
    }

    function handleFileChange(event){
      uploadFile = event.target.files[0];
      document.getElementById("uploadFileName").innerText = uploadFile ? "Arquivo selecionado: " + uploadFile.name : "";
      updateUploadButtonState();
    }
    function handleAutorizacaoChange(event){
      autorizacao = event.target.checked;
      updateUploadButtonState();
    }
    function updateUploadButtonState(){
      const btn = document.getElementById("confirmUploadBtn");
      btn.disabled = !(uploadFile && autorizacao);
    }

    async function confirmUpload(){
      if(!(uploadFile && autorizacao)) return;
      document.getElementById("confirmUploadBtn").disabled = true;
      document.getElementById("uploadStatus").innerHTML = "Enviando arquivo...";
      try {
        // Nome: treino_hoje_nomealuna_timestamp.ext
        const ext = uploadFile.name.split('.').pop();
        const safeName = nomeSelecionado.replace(/[^a-z0-9]/gi,'_').toLowerCase();
        const fileName = `treino_hoje_${safeName}_${Date.now()}.${ext}`;
        const storageRef = storage.ref().child("uploads/"+fileName);
        await storageRef.put(uploadFile);
        // Atualiza Firestore +10 pontos
        const snap = await db.collection("usuarios").where("nome","==",nomeSelecionado).get();
        if(!snap.empty){
          const docUser = snap.docs[0];
          const pontosAtuais = docUser.data().pontos ?? 0;
          await db.collection("usuarios").doc(docUser.id).update({pontos: pontosAtuais + 10});
        }
        document.getElementById("uploadStatus").innerHTML = "";
        showUploadSuccess(nomeSelecionado);
        document.getElementById("extraPointsArea").innerHTML = "";
      } catch(e){
        document.getElementById("uploadStatus").innerHTML = "Erro no envio, tente novamente!";
        document.getElementById("confirmUploadBtn").disabled = false;
      }
    }

    function showUploadSuccess(nome){
      const motivacoes = [
        "Você é inspiração! Parabéns pelo envio!",
        "Treino registrado, +10 pontos! Continue assim!",
        "Sua dedicação vai longe! Mantenha o foco!",
        "Exemplo de superação, parabéns!",
        "Sua energia motiva outras mulheres!"
      ];
      const msg = motivacoes[Math.floor(Math.random()*motivacoes.length)];
      document.getElementById("checkinResult").innerHTML = `
        <div class="checkin-success">
          🎉 Parabéns, ${nome}! Você ganhou mais 10 pontos pelo envio do treino!
          <div class="checkin-motivation">${msg}</div>
        </div>
      `;
      confetti();
      setTimeout(()=>document.getElementById("checkinResult").innerHTML="", 4000);
    }

    // Confetti animation
    function confetti(){
      const colors=["#ffd700","#7209b7","#38b4ff","#ff4d6d","#b0b0b0"];
      const confettiDiv = document.createElement("div");
      confettiDiv.className = "confetti";
      for(let i=0;i<60;i++){
        const span = document.createElement("span");
        const size = Math.random()*11+8;
        span.style.position="absolute";
        span.style.width=size+"px";
        span.style.height=size+"px";
        span.style.background=colors[Math.floor(Math.random()*colors.length)];
        span.style.borderRadius="50%";
        span.style.left=Math.random()*100+"vw";
        span.style.top=Math.random()*80+"vh";
        span.style.opacity=Math.random()*0.6+0.4;
        span.style.transform=`rotate(${Math.random()*360}deg)`;
        confettiDiv.appendChild(span);
      }
      document.body.appendChild(confettiDiv);
      setTimeout(()=>confettiDiv.remove(), 2300);
    }

    async function carregarNomes(){
      const snap = await db.collection("usuarios").get();
      todasAlunas = [];
      snap.forEach(doc => {
        const d = doc.data();
        todasAlunas.push({
          nome: d.nome,
        });
      });
      preencherSelect();
    }

    async function inicializarCheckin(){
      await carregarCodigoTreino();
      await carregarNomes();
    }
    inicializarCheckin();
  </script>
</body>
</html>
