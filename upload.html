<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Envie sua mídia — Desafio 40+</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-1:#0b1e33; --card:#0f2b52; --stroke:#29486d;
      --text:#e6f0ff; --muted:#a9c5ff; --brand:#3b82f6; --brand-2:#6aa6ff; --ok:#22c55e; --err:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; display:grid; place-items:center; color:var(--text);
      font-family:Poppins,system-ui; background:radial-gradient(1200px 600px at 70% -10%, #16345c 0%, #0b1e33 60%, #081628 100%);
    }
    .card{width:min(720px,92vw); background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));
      border:1px solid var(--stroke); border-radius:18px; padding:28px 24px;
      box-shadow:0 20px 40px rgba(0,0,0,.35)}
    h1{margin:0 0 6px; text-align:center; font-size:30px}
    p.muted{margin:0 0 22px; text-align:center; color:var(--muted)}
    input[type=file]{width:100%; background:#0d2750; color:var(--text); border:1px solid var(--stroke);
      border-radius:12px; padding:10px 12px}
    button{
      width:100%; height:48px; border:0; border-radius:12px; margin-top:16px;
      background:linear-gradient(180deg,var(--brand),var(--brand-2)); color:#fff; font-weight:700; cursor:pointer
    }
    .msg{margin-top:12px; padding:10px 12px; border-radius:10px}
    .ok{background:rgba(34,197,94,.12); border:1px solid rgba(34,197,94,.35)}
    .err{background:rgba(239,68,68,.12); border:1px solid rgba(239,68,68,.35)}
    .link{display:inline-block; margin-top:14px; color:var(--muted); text-decoration:none}
  </style>
</head>
<body>
  <main class="card">
    <h1>Ganhe +10 pontos!</h1>
    <p class="muted">Envie uma <strong>foto ou vídeo</strong> da <strong>aula de hoje</strong>. Mídias antigas fazem perder pontos.</p>

    <input id="file" type="file" accept="image/*,video/*" />
    <button id="send">Enviar mídia</button>
    <div id="msg"></div>
    <a class="link" href="index.html">← Voltar ao ranking</a>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getFirestore, doc, updateDoc, increment, addDoc, collection, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // Firebase (mesmo de antes)
    const firebaseConfig = {
      apiKey: "AIzaSyAMf0Z5_a1DufNRCTHGPGC6ZBE9T2-tYAU",
      authDomain: "clube-aguiar-live.firebaseapp.com",
      projectId: "clube-aguiar-live",
      storageBucket: "clube-aguiar-live.appspot.com",
      messagingSenderId: "694025911850",
      appId: "1:694025911850:web:5f0c6117dbc60b15118d53"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // Cloudinary (unsigned)
    const CLOUD_NAME = "dj6gmz0pa";
    const UPLOAD_PRESET = "aguiar_unsigned";
    const UPLOAD_URL = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`;

    const $file = document.getElementById('file');
    const $btn  = document.getElementById('send');
    const $msg  = document.getElementById('msg');

    const urlParams = new URLSearchParams(location.search);
    const playerId  = urlParams.get('pid') || '';
    const playerName= decodeURIComponent(urlParams.get('name') || '');

    function toast(t, ok=false){ $msg.className='msg ' + (ok?'ok':'err'); $msg.textContent=t; }

    async function uploadToCloudinary(file){
      const fd = new FormData();
      fd.append('file', file);
      fd.append('upload_preset', UPLOAD_PRESET);
      fd.append('folder', 'desafio40mais');
      fd.append('tags', 'desafio40plus,checkin');
      // contexto opcional
      fd.append('context', `caption=Aluno(a): ${playerName}`);

      const res = await fetch(UPLOAD_URL, { method:'POST', body:fd });
      if(!res.ok) throw new Error('Falha no upload Cloudinary');
      return res.json(); // {secure_url, resource_type, ...}
    }

    $btn.addEventListener('click', async ()=>{
      $msg.textContent=''; $msg.className='';
      const file = $file.files?.[0];
      if(!file){ toast('Selecione uma foto ou um vídeo.'); return; }
      if(!playerId){ toast('Sessão inválida (sem atleta). Volte ao check-in.'); return; }

      try{
        $btn.disabled = true;
        const up = await uploadToCloudinary(file);

        // Salva registro de upload (para auditoria)
        await addDoc(collection(db,'uploads'),{
          playerId, playerName, url: up.secure_url, type: up.resource_type,
          createdAt: serverTimestamp(), points: 10
        });

        // Tenta somar +10 pontos no ranking
        let pointsOk = true;
        try{
          await updateDoc(doc(db,'ranking',playerId),{ points: increment(10) });
        }catch(_){ pointsOk = false; }

        if(pointsOk){
          toast('Parabéns! Upload recebido e +10 pontos somados!', true);
        }else{
          toast('Upload recebido! Seus +10 pontos serão validados pela equipe.', true);
        }

        setTimeout(()=>location.href='index.html', 1200);

      }catch(e){
        console.error(e);
        toast('Erro ao enviar sua mídia.');
      }finally{
        $btn.disabled = false;
      }
    });
  </script>
</body>
</html>
